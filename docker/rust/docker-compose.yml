# NextGCore 5G Core + NextGSim RAN
# Full E2E deployment: MongoDB + 5GC NFs + gNB + UE
#
# Prerequisites:
#   ./build.sh   (builds all Docker images)
#
# Usage:
#   docker compose up -d              # Start all services
#   docker compose logs -f amf gnb ue # Follow key logs
#   docker compose down               # Stop all services

x-common: &common
  restart: on-failure:5
  environment: &common-env
    RUST_LOG: info
    RUST_BACKTRACE: 1

x-nf-healthcheck: &nf-healthcheck
  healthcheck:
    test: ["CMD-SHELL", "kill -0 1"]
    interval: 10s
    timeout: 5s
    retries: 3
    start_period: 5s

services:
  # ==========================================================================
  # Infrastructure
  # ==========================================================================
  mongodb:
    image: mongo:6.0
    container_name: nextgcore-mongodb
    <<: *common
    environment:
      MONGO_INITDB_DATABASE: nextgcore
    volumes:
      - mongodb_data:/data/db
      - ../../docs/assets/webui/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    networks:
      core:
        ipv4_address: 172.23.0.2
    ports:
      - "27017:27017"
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ==========================================================================
  # 5G Core - Control Plane
  # ==========================================================================
  nrf:
    image: nextgcore-rust/nrf:latest
    container_name: nextgcore-nrf
    <<: [*common, *nf-healthcheck]
    command: ["-c", "/etc/nextgcore/nrf.yaml"]
    volumes:
      - ./configs/5gc/nrf.yaml:/etc/nextgcore/nrf.yaml:ro
    networks:
      core:
        ipv4_address: 172.23.0.10
    ports:
      - "7777:7777"
    depends_on:
      mongodb:
        condition: service_healthy

  ausf:
    image: nextgcore-rust/ausf:latest
    container_name: nextgcore-ausf
    <<: [*common, *nf-healthcheck]
    environment:
      <<: *common-env
      UDM_SBI_ADDR: 172.23.0.12
      UDM_SBI_PORT: "7777"
    command: ["-c", "/etc/nextgcore/ausf.yaml"]
    volumes:
      - ./configs/5gc/ausf.yaml:/etc/nextgcore/ausf.yaml:ro
    networks:
      core:
        ipv4_address: 172.23.0.11
    depends_on:
      nrf:
        condition: service_healthy
      udm:
        condition: service_healthy

  udm:
    image: nextgcore-rust/udm:latest
    container_name: nextgcore-udm
    <<: [*common, *nf-healthcheck]
    environment:
      <<: *common-env
      UDR_SBI_ADDR: 172.23.0.20
      UDR_SBI_PORT: "7777"
    command: ["-c", "/etc/nextgcore/udm.yaml"]
    volumes:
      - ./configs/5gc/udm.yaml:/etc/nextgcore/udm.yaml:ro
      - ./configs/5gc/hnet:/etc/nextgcore/hnet:ro
    networks:
      core:
        ipv4_address: 172.23.0.12
    depends_on:
      nrf:
        condition: service_healthy

  udr:
    image: nextgcore-rust/udr:latest
    container_name: nextgcore-udr
    <<: [*common, *nf-healthcheck]
    command: ["-c", "/etc/nextgcore/udr.yaml"]
    volumes:
      - ./configs/5gc/udr.yaml:/etc/nextgcore/udr.yaml:ro
    networks:
      core:
        ipv4_address: 172.23.0.20
    depends_on:
      nrf:
        condition: service_healthy
      mongodb:
        condition: service_healthy

  pcf:
    image: nextgcore-rust/pcf:latest
    container_name: nextgcore-pcf
    <<: [*common, *nf-healthcheck]
    command: ["-c", "/etc/nextgcore/pcf.yaml"]
    volumes:
      - ./configs/5gc/pcf.yaml:/etc/nextgcore/pcf.yaml:ro
    networks:
      core:
        ipv4_address: 172.23.0.13
    depends_on:
      nrf:
        condition: service_healthy

  nssf:
    image: nextgcore-rust/nssf:latest
    container_name: nextgcore-nssf
    <<: [*common, *nf-healthcheck]
    command: ["-c", "/etc/nextgcore/nssf.yaml"]
    volumes:
      - ./configs/5gc/nssf.yaml:/etc/nextgcore/nssf.yaml:ro
    networks:
      core:
        ipv4_address: 172.23.0.14
    depends_on:
      nrf:
        condition: service_healthy

  bsf:
    image: nextgcore-rust/bsf:latest
    container_name: nextgcore-bsf
    <<: [*common, *nf-healthcheck]
    command: ["-c", "/etc/nextgcore/bsf.yaml"]
    volumes:
      - ./configs/5gc/bsf.yaml:/etc/nextgcore/bsf.yaml:ro
    networks:
      core:
        ipv4_address: 172.23.0.15
    depends_on:
      nrf:
        condition: service_healthy

  # ==========================================================================
  # 5G Core - Access + Session Management
  # ==========================================================================
  amf:
    image: nextgcore-rust/amf:latest
    container_name: nextgcore-amf
    <<: [*common, *nf-healthcheck]
    environment:
      <<: *common-env
      RUST_LOG: info,nextgcore_amfd=debug
      SMF_SBI_ADDR: 172.23.0.4
      SMF_SBI_PORT: "7777"
      AUSF_SBI_ADDR: 172.23.0.11
      AUSF_SBI_PORT: "7777"
    command: ["-c", "/etc/nextgcore/amf.yaml"]
    volumes:
      - ./configs/5gc/amf.yaml:/etc/nextgcore/amf.yaml:ro
    networks:
      core:
        ipv4_address: 172.23.0.5
    ports:
      - "38412:38412/udp"
    depends_on:
      nrf:
        condition: service_healthy
      ausf:
        condition: service_healthy
      udm:
        condition: service_healthy
      pcf:
        condition: service_healthy
      nssf:
        condition: service_healthy

  smf:
    image: nextgcore-rust/smf:latest
    container_name: nextgcore-smf
    <<: [*common, *nf-healthcheck]
    environment:
      <<: *common-env
      UPF_PFCP_ADDR: 172.23.0.7
      UPF_PFCP_PORT: "8805"
      SMF_PFCP_ADDR: 172.23.0.4
    command: ["-c", "/etc/nextgcore/smf.yaml"]
    volumes:
      - ./configs/5gc/smf.yaml:/etc/nextgcore/smf.yaml:ro
    networks:
      core:
        ipv4_address: 172.23.0.4
    ports:
      - "8805:8805/udp"
    depends_on:
      nrf:
        condition: service_healthy
      pcf:
        condition: service_healthy
      amf:
        condition: service_healthy

  # ==========================================================================
  # 5G Core - User Plane
  # ==========================================================================
  upf:
    image: nextgcore-rust/upf:latest
    container_name: nextgcore-upf
    <<: *common
    privileged: true
    user: root
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    sysctls:
      - net.ipv4.ip_forward=1
    environment:
      <<: *common-env
      RUST_LOG: info,nextgcore_upfd=debug
    command: ["-c", "/etc/nextgcore/upf.yaml", "--pfcp-addr", "172.23.0.7", "--gtpu-addr", "172.23.0.7", "--tun-ip", "10.45.0.1", "--tun-prefix", "16"]
    volumes:
      - ./configs/5gc/upf.yaml:/etc/nextgcore/upf.yaml:ro
    networks:
      core:
        ipv4_address: 172.23.0.7
    ports:
      - "2152:2152/udp"
    healthcheck:
      test: ["CMD-SHELL", "kill -0 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    depends_on:
      smf:
        condition: service_healthy

  # ==========================================================================
  # RAN - gNB + UE Simulator
  # ==========================================================================
  gnb:
    image: nextgsim-gnb:latest
    container_name: nextgsim-gnb
    <<: *common
    environment:
      RUST_LOG: info,nextgsim_gnb=debug,nextgsim_sctp=debug,nextgsim_ngap=debug
    command: ["-c", "/etc/nextgsim/gnb.yaml"]
    volumes:
      - ../../../nextgsim/config:/etc/nextgsim:ro
    networks:
      core:
        ipv4_address: 172.23.0.100
    healthcheck:
      test: ["CMD-SHELL", "kill -0 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on:
      amf:
        condition: service_healthy
      upf:
        condition: service_healthy

  ue:
    image: nextgsim-ue:latest
    container_name: nextgsim-ue
    <<: *common
    environment:
      RUST_LOG: info,nextgsim_ue=debug,nextgsim_nas=debug
    command: ["-c", "/etc/nextgsim/ue.yaml"]
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - ../../../nextgsim/config:/etc/nextgsim:ro
    networks:
      core:
        ipv4_address: 172.23.0.101
    healthcheck:
      test: ["CMD-SHELL", "kill -0 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    depends_on:
      gnb:
        condition: service_healthy

  # ==========================================================================
  # Observability (Items 120-123)
  # ==========================================================================
  prometheus:
    image: prom/prometheus:v2.51.0
    container_name: nextgcore-prometheus
    <<: *common
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=7d"
      - "--web.enable-lifecycle"
    volumes:
      - ./configs/observability/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./configs/observability/alert-rules.yml:/etc/prometheus/alert-rules.yml:ro
      - prometheus_data:/prometheus
    networks:
      core:
        ipv4_address: 172.23.0.200
    ports:
      - "9090:9090"
    healthcheck:
      test: ["CMD", "wget", "-q", "--tries=1", "-O", "/dev/null", "http://localhost:9090/-/healthy"]
      interval: 15s
      timeout: 5s
      retries: 3

  grafana:
    image: grafana/grafana:10.4.0
    container_name: nextgcore-grafana
    <<: *common
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: nextgcore
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH: /var/lib/grafana/dashboards/overview.json
    volumes:
      - ./configs/observability/grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
      - ./configs/observability/grafana-dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml:ro
      - ./configs/observability/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    networks:
      core:
        ipv4_address: 172.23.0.201
    ports:
      - "3000:3000"
    depends_on:
      prometheus:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--tries=1", "-O", "/dev/null", "http://localhost:3000/api/health"]
      interval: 15s
      timeout: 5s
      retries: 3

  jaeger:
    image: jaegertracing/all-in-one:1.55
    container_name: nextgcore-jaeger
    <<: *common
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    networks:
      core:
        ipv4_address: 172.23.0.202
    ports:
      - "16686:16686"   # Jaeger UI
      - "4317:4317"     # OTLP gRPC
      - "4318:4318"     # OTLP HTTP
    healthcheck:
      test: ["CMD", "wget", "-q", "--tries=1", "-O", "/dev/null", "http://localhost:14269/"]
      interval: 15s
      timeout: 5s
      retries: 3

# ==========================================================================
# Network
# ==========================================================================
networks:
  core:
    driver: bridge
    ipam:
      config:
        - subnet: 172.23.0.0/24
          gateway: 172.23.0.1

volumes:
  mongodb_data:
  prometheus_data:
  grafana_data:

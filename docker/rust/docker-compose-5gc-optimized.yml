# NextGCore Rust 5G Core Docker Compose - Optimized Build
# Uses pre-built binaries from local build to avoid building in Docker
#
# Prerequisites:
#   1. Build binaries locally: cd nextgcore/src && cargo build --release
#   2. Copy binaries: cp -r target/release/nextgcore-* ../docker/rust/binaries/
#
# Usage:
#   docker compose -f docker-compose-5gc-optimized.yml up -d
#   docker compose -f docker-compose-5gc-optimized.yml down
#
# Network Functions included:
#   - NRF (Network Repository Function)
#   - AUSF (Authentication Server Function)
#   - UDM (Unified Data Management)
#   - UDR (Unified Data Repository)
#   - PCF (Policy Control Function)
#   - NSSF (Network Slice Selection Function)
#   - BSF (Binding Support Function)
#   - AMF (Access and Mobility Management Function)
#   - SMF (Session Management Function)
#   - UPF (User Plane Function)

x-common-env: &common-env
  RUST_LOG: info
  RUST_BACKTRACE: 1

x-common-restart: &common-restart
  restart: unless-stopped

x-common-healthcheck: &common-healthcheck
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 10s

x-common-build: &common-build
  context: .
  dockerfile: Dockerfile.runtime

services:
  # ==========================================================================
  # Infrastructure Services
  # ==========================================================================
  mongodb:
    image: mongo:6.0
    container_name: nextgcore-5gc-mongodb
    <<: *common-restart
    environment:
      MONGO_INITDB_DATABASE: nextgcore
    volumes:
      - mongodb_data:/data/db
      - ../../docs/assets/webui/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    networks:
      nextgcore-5gc:
        ipv4_address: 172.23.0.2
    ports:
      - "27017:27017"
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      <<: *common-healthcheck

  # ==========================================================================
  # 5G Core Control Plane - Core NFs
  # ==========================================================================

  # NRF - Network Repository Function
  # Central registry for NF discovery and management
  nrf:
    build:
      <<: *common-build
      args:
        NF_NAME: nextgcore-nrfd
    image: nextgcore-rust/nrf:latest
    container_name: nextgcore-5gc-nrf
    <<: *common-restart
    environment:
      <<: *common-env
    command: ["--sbi-addr", "0.0.0.0", "--sbi-port", "7777", "-c", "/etc/nextgcore/nextgcore-nrfd.yaml"]
    volumes:
      - ./configs/5gc/nrf.yaml:/etc/nextgcore/nextgcore-nrfd.yaml:ro
      - logs_nrf:/var/log/nextgcore
    networks:
      nextgcore-5gc:
        ipv4_address: 172.23.0.10
    ports:
      - "7777:7777"  # SBI
    depends_on:
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pgrep", "-f", "nf-binary"]
      <<: *common-healthcheck

  # AUSF - Authentication Server Function
  # Handles UE authentication
  ausf:
    build:
      <<: *common-build
      args:
        NF_NAME: nextgcore-ausfd
    image: nextgcore-rust/ausf:latest
    container_name: nextgcore-5gc-ausf
    <<: *common-restart
    environment:
      <<: *common-env
    command: ["-c", "/etc/nextgcore/nextgcore-ausfd.yaml"]
    volumes:
      - ./configs/5gc/ausf.yaml:/etc/nextgcore/nextgcore-ausfd.yaml:ro
      - logs_ausf:/var/log/nextgcore
    networks:
      nextgcore-5gc:
        ipv4_address: 172.23.0.11
    depends_on:
      - nrf
    healthcheck:
      test: ["CMD", "pgrep", "-f", "nf-binary"]
      <<: *common-healthcheck

  # UDM - Unified Data Management
  # Manages subscriber data and authentication credentials
  udm:
    build:
      <<: *common-build
      args:
        NF_NAME: nextgcore-udmd
    image: nextgcore-rust/udm:latest
    container_name: nextgcore-5gc-udm
    <<: *common-restart
    environment:
      <<: *common-env
    command: ["-c", "/etc/nextgcore/nextgcore-udmd.yaml"]
    volumes:
      - ./configs/5gc/udm.yaml:/etc/nextgcore/nextgcore-udmd.yaml:ro
      - ./configs/5gc/hnet:/etc/nextgcore/hnet:ro
      - logs_udm:/var/log/nextgcore
    networks:
      nextgcore-5gc:
        ipv4_address: 172.23.0.12
    depends_on:
      - nrf
    healthcheck:
      test: ["CMD", "pgrep", "-f", "nf-binary"]
      <<: *common-healthcheck

  # UDR - Unified Data Repository
  # Stores subscriber and policy data in MongoDB
  udr:
    build:
      <<: *common-build
      args:
        NF_NAME: nextgcore-udrd
    image: nextgcore-rust/udr:latest
    container_name: nextgcore-5gc-udr
    <<: *common-restart
    environment:
      <<: *common-env
    command: ["-c", "/etc/nextgcore/nextgcore-udrd.yaml"]
    volumes:
      - ./configs/5gc/udr.yaml:/etc/nextgcore/nextgcore-udrd.yaml:ro
      - logs_udr:/var/log/nextgcore
    networks:
      nextgcore-5gc:
        ipv4_address: 172.23.0.20
    depends_on:
      - nrf
      - mongodb
    healthcheck:
      test: ["CMD", "pgrep", "-f", "nf-binary"]
      <<: *common-healthcheck

  # PCF - Policy Control Function
  # Manages policy rules and QoS
  pcf:
    build:
      <<: *common-build
      args:
        NF_NAME: nextgcore-pcfd
    image: nextgcore-rust/pcf:latest
    container_name: nextgcore-5gc-pcf
    <<: *common-restart
    environment:
      <<: *common-env
    command: ["-c", "/etc/nextgcore/nextgcore-pcfd.yaml"]
    volumes:
      - ./configs/5gc/pcf.yaml:/etc/nextgcore/nextgcore-pcfd.yaml:ro
      - logs_pcf:/var/log/nextgcore
    networks:
      nextgcore-5gc:
        ipv4_address: 172.23.0.13
    ports:
      - "9093:9090"  # Metrics
    depends_on:
      - nrf
      - mongodb
    healthcheck:
      test: ["CMD", "pgrep", "-f", "nf-binary"]
      <<: *common-healthcheck

  # NSSF - Network Slice Selection Function
  # Selects network slices for UEs
  nssf:
    build:
      <<: *common-build
      args:
        NF_NAME: nextgcore-nssfd
    image: nextgcore-rust/nssf:latest
    container_name: nextgcore-5gc-nssf
    <<: *common-restart
    environment:
      <<: *common-env
    command: ["-c", "/etc/nextgcore/nextgcore-nssfd.yaml"]
    volumes:
      - ./configs/5gc/nssf.yaml:/etc/nextgcore/nextgcore-nssfd.yaml:ro
      - logs_nssf:/var/log/nextgcore
    networks:
      nextgcore-5gc:
        ipv4_address: 172.23.0.14
    depends_on:
      - nrf
    healthcheck:
      test: ["CMD", "pgrep", "-f", "nf-binary"]
      <<: *common-healthcheck

  # BSF - Binding Support Function
  # Manages PCF bindings for UE sessions
  bsf:
    build:
      <<: *common-build
      args:
        NF_NAME: nextgcore-bsfd
    image: nextgcore-rust/bsf:latest
    container_name: nextgcore-5gc-bsf
    <<: *common-restart
    environment:
      <<: *common-env
    command: ["-c", "/etc/nextgcore/nextgcore-bsfd.yaml"]
    volumes:
      - ./configs/5gc/bsf.yaml:/etc/nextgcore/nextgcore-bsfd.yaml:ro
      - logs_bsf:/var/log/nextgcore
    networks:
      nextgcore-5gc:
        ipv4_address: 172.23.0.15
    depends_on:
      - nrf
      - mongodb
    healthcheck:
      test: ["CMD", "pgrep", "-f", "nf-binary"]
      <<: *common-healthcheck

  # ==========================================================================
  # 5G Core Control Plane - Access NFs
  # ==========================================================================

  # AMF - Access and Mobility Management Function
  # Handles UE registration, mobility, and connection management
  amf:
    build:
      <<: *common-build
      args:
        NF_NAME: nextgcore-amfd
    image: nextgcore-rust/amf:latest
    container_name: nextgcore-5gc-amf
    <<: *common-restart
    environment:
      <<: *common-env
    command: ["-c", "/etc/nextgcore/nextgcore-amfd.yaml"]
    volumes:
      - ./configs/5gc/amf.yaml:/etc/nextgcore/nextgcore-amfd.yaml:ro
      - logs_amf:/var/log/nextgcore
    networks:
      nextgcore-5gc:
        ipv4_address: 172.23.0.5
    ports:
      - "38412:38412/sctp"  # NGAP (N2 interface to gNB)
      - "9091:9090"         # Metrics
    depends_on:
      - nrf
      - ausf
      - udm
      - pcf
      - nssf
    healthcheck:
      test: ["CMD", "pgrep", "-f", "nf-binary"]
      <<: *common-healthcheck

  # SMF - Session Management Function
  # Manages PDU sessions and UPF selection
  smf:
    build:
      <<: *common-build
      args:
        NF_NAME: nextgcore-smfd
    image: nextgcore-rust/smf:latest
    container_name: nextgcore-5gc-smf
    <<: *common-restart
    environment:
      <<: *common-env
    command: ["-c", "/etc/nextgcore/nextgcore-smfd.yaml"]
    volumes:
      - ./configs/5gc/smf.yaml:/etc/nextgcore/nextgcore-smfd.yaml:ro
      - logs_smf:/var/log/nextgcore
    networks:
      nextgcore-5gc:
        ipv4_address: 172.23.0.4
    ports:
      - "8805:8805/udp"  # PFCP (N4 interface to UPF)
      - "9092:9090"      # Metrics
    depends_on:
      - nrf
      - pcf
      - amf
    healthcheck:
      test: ["CMD", "pgrep", "-f", "nf-binary"]
      <<: *common-healthcheck

  # ==========================================================================
  # 5G Core User Plane
  # ==========================================================================

  # UPF - User Plane Function
  # Handles user data forwarding and packet processing
  upf:
    build:
      context: .
      dockerfile: Dockerfile.upf
    image: nextgcore-rust/upf:latest
    container_name: nextgcore-5gc-upf
    <<: *common-restart
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.disable_ipv6=0
      - net.ipv6.conf.all.forwarding=1
    environment:
      <<: *common-env
    command: [
      "-c", "/etc/nextgcore/nextgcore-upfd.yaml",
      "--pfcp-addr", "172.23.0.7",
      "--gtpu-addr", "172.23.0.7"
    ]
    volumes:
      - ./configs/5gc/upf.yaml:/etc/nextgcore/nextgcore-upfd.yaml:ro
      - logs_upf:/var/log/nextgcore
    networks:
      nextgcore-5gc:
        ipv4_address: 172.23.0.7
    ports:
      - "2152:2152/udp"  # GTP-U (N3 interface to gNB)
      - "9094:9090"      # Metrics
    depends_on:
      - smf
    healthcheck:
      test: ["CMD", "pgrep", "-f", "nf-binary"]
      <<: *common-healthcheck

# ==========================================================================
# Networks
# ==========================================================================
networks:
  nextgcore-5gc:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.23.0.0/24
          gateway: 172.23.0.1

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  mongodb_data:
    name: nextgcore-5gc-mongodb-data
  logs_nrf:
    name: nextgcore-5gc-logs-nrf
  logs_ausf:
    name: nextgcore-5gc-logs-ausf
  logs_udm:
    name: nextgcore-5gc-logs-udm
  logs_udr:
    name: nextgcore-5gc-logs-udr
  logs_pcf:
    name: nextgcore-5gc-logs-pcf
  logs_nssf:
    name: nextgcore-5gc-logs-nssf
  logs_bsf:
    name: nextgcore-5gc-logs-bsf
  logs_amf:
    name: nextgcore-5gc-logs-amf
  logs_smf:
    name: nextgcore-5gc-logs-smf
  logs_upf:
    name: nextgcore-5gc-logs-upf

# NextGCore Rust EPC (Evolved Packet Core) Docker Compose
# Standalone 4G/LTE EPC deployment with all required network functions
#
# Usage:
#   docker compose -f docker-compose-epc.yml up -d
#   docker compose -f docker-compose-epc.yml down
#
# Network Functions included:
#   - MME (Mobility Management Entity)
#   - HSS (Home Subscriber Server)
#   - PCRF (Policy and Charging Rules Function)
#   - SGW-C (Serving Gateway - Control Plane)
#   - SGW-U (Serving Gateway - User Plane)
#
# Note: SMF and UPF from 5GC are used as PGW-C and PGW-U respectively
# for combined EPC/5GC deployments

x-common-env: &common-env
  RUST_LOG: info
  RUST_BACKTRACE: 1

x-common-restart: &common-restart
  restart: unless-stopped

x-common-healthcheck: &common-healthcheck
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 10s

services:
  # ==========================================================================
  # Infrastructure Services
  # ==========================================================================
  mongodb:
    image: mongo:6.0
    container_name: nextgcore-epc-mongodb
    <<: *common-restart
    environment:
      MONGO_INITDB_DATABASE: nextgcore
    volumes:
      - mongodb_data:/data/db
      - ../../docs/assets/webui/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    networks:
      nextgcore-epc:
        ipv4_address: 172.24.0.2
    ports:
      - "27017:27017"
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      <<: *common-healthcheck

  # ==========================================================================
  # EPC Control Plane - Core NFs
  # ==========================================================================

  # HSS - Home Subscriber Server
  # Manages subscriber data and authentication
  hss:
    build:
      context: ../..
      dockerfile: docker/rust/Dockerfile.nf-template
      args:
        NF_NAME: nextgcore-hssd
    image: nextgcore-rust/hss:latest
    container_name: nextgcore-epc-hss
    <<: *common-restart
    environment:
      <<: *common-env
    volumes:
      - ./configs/epc/hss.yaml:/etc/nextgcore/nextgcore-hssd.yaml:ro
      - ./configs/epc/freeDiameter/hss.conf:/etc/freeDiameter/hss.conf:ro
      - logs_hss:/var/log/nextgcore
    networks:
      nextgcore-epc:
        ipv4_address: 172.24.0.8
    ports:
      - "3868:3868/tcp"   # Diameter (S6a)
      - "3868:3868/sctp"  # Diameter over SCTP
      - "9098:9090"       # Metrics
    depends_on:
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pgrep", "-f", "nextgcore-hssd"]
      <<: *common-healthcheck

  # PCRF - Policy and Charging Rules Function
  # Manages policy rules and QoS for EPC
  pcrf:
    build:
      context: ../..
      dockerfile: docker/rust/Dockerfile.nf-template
      args:
        NF_NAME: nextgcore-pcrfd
    image: nextgcore-rust/pcrf:latest
    container_name: nextgcore-epc-pcrf
    <<: *common-restart
    environment:
      <<: *common-env
    volumes:
      - ./configs/epc/pcrf.yaml:/etc/nextgcore/nextgcore-pcrfd.yaml:ro
      - ./configs/epc/freeDiameter/pcrf.conf:/etc/freeDiameter/pcrf.conf:ro
      - logs_pcrf:/var/log/nextgcore
    networks:
      nextgcore-epc:
        ipv4_address: 172.24.0.9
    ports:
      - "3869:3868/tcp"   # Diameter (Gx)
      - "9099:9090"       # Metrics
    depends_on:
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pgrep", "-f", "nextgcore-pcrfd"]
      <<: *common-healthcheck

  # SGW-C - Serving Gateway Control Plane
  # Handles control plane signaling for user data routing
  sgwc:
    build:
      context: ../..
      dockerfile: docker/rust/Dockerfile.nf-template
      args:
        NF_NAME: nextgcore-sgwcd
    image: nextgcore-rust/sgwc:latest
    container_name: nextgcore-epc-sgwc
    <<: *common-restart
    environment:
      <<: *common-env
    volumes:
      - ./configs/epc/sgwc.yaml:/etc/nextgcore/nextgcore-sgwcd.yaml:ro
      - logs_sgwc:/var/log/nextgcore
    networks:
      nextgcore-epc:
        ipv4_address: 172.24.0.3
    ports:
      - "2123:2123/udp"  # GTP-C (S11 interface to MME)
      - "8805:8805/udp"  # PFCP (Sxa interface to SGW-U)
    healthcheck:
      test: ["CMD", "pgrep", "-f", "nextgcore-sgwcd"]
      <<: *common-healthcheck

  # MME - Mobility Management Entity
  # Handles UE registration, mobility, and connection management for LTE
  mme:
    build:
      context: ../..
      dockerfile: docker/rust/Dockerfile.nf-template
      args:
        NF_NAME: nextgcore-mmed
    image: nextgcore-rust/mme:latest
    container_name: nextgcore-epc-mme
    <<: *common-restart
    environment:
      <<: *common-env
    volumes:
      - ./configs/epc/mme.yaml:/etc/nextgcore/nextgcore-mmed.yaml:ro
      - ./configs/epc/freeDiameter/mme.conf:/etc/freeDiameter/mme.conf:ro
      - logs_mme:/var/log/nextgcore
    networks:
      nextgcore-epc:
        ipv4_address: 172.24.0.5
    ports:
      - "36412:36412/sctp"  # S1AP (S1-MME interface to eNB)
      - "9095:9090"         # Metrics
    depends_on:
      - hss
      - sgwc
    healthcheck:
      test: ["CMD", "pgrep", "-f", "nextgcore-mmed"]
      <<: *common-healthcheck

  # ==========================================================================
  # EPC User Plane
  # ==========================================================================

  # SGW-U - Serving Gateway User Plane
  # Handles user plane data forwarding between eNB and PGW-U
  sgwu:
    build:
      context: ../..
      dockerfile: docker/rust/Dockerfile.nf-template
      args:
        NF_NAME: nextgcore-sgwud
    image: nextgcore-rust/sgwu:latest
    container_name: nextgcore-epc-sgwu
    <<: *common-restart
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1
    environment:
      <<: *common-env
    volumes:
      - ./configs/epc/sgwu.yaml:/etc/nextgcore/nextgcore-sgwud.yaml:ro
      - logs_sgwu:/var/log/nextgcore
    networks:
      nextgcore-epc:
        ipv4_address: 172.24.0.6
    ports:
      - "2152:2152/udp"  # GTP-U (S1-U interface to eNB)
    depends_on:
      - sgwc
    healthcheck:
      test: ["CMD", "pgrep", "-f", "nextgcore-sgwud"]
      <<: *common-healthcheck

# ==========================================================================
# Networks
# ==========================================================================
networks:
  nextgcore-epc:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.24.0.0/24
          gateway: 172.24.0.1

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  mongodb_data:
    name: nextgcore-epc-mongodb-data
  logs_hss:
    name: nextgcore-epc-logs-hss
  logs_pcrf:
    name: nextgcore-epc-logs-pcrf
  logs_sgwc:
    name: nextgcore-epc-logs-sgwc
  logs_mme:
    name: nextgcore-epc-logs-mme
  logs_sgwu:
    name: nextgcore-epc-logs-sgwu
